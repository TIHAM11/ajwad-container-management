<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Add / Edit Container | Ajwad</title>
    <script src="auth.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="navbar">
    <h2 class="logo">Ajwad</h2>
    <ul>
        <li><a href="index.html">Dashboard</a></li>
        <li><a href="add-container.html" class="active">Add Container</a></li>
        <li><a href="containers.html">Containers</a></li>
        <li><button onclick="logoutUser()" class="logout-btn">Logout</button></li>
    </ul>
</nav>

<div class="page">

    <header class="header">
        <h1 id="formTitle">Add New Container</h1>
        <p id="formSubtitle">Enter container-wise cost, bags & selling details</p>
    </header>

    <section class="containers">

        <form id="containerForm">
            <table>

                <tr>
                    <td>Container Date</td>
                    <td><input type="date" id="containerDate" required></td>
                </tr>

                <tr>
                    <td>Container Number</td>
                    <td><input type="text" id="containerNo" placeholder="AJW-000" required></td>
                </tr>

                <tr>
                    <td>Item</td>
                    <td><input type="text" id="item" placeholder="Fruits & Vegetables" required></td>
                </tr>

                <!-- BUSINESS FIELDS -->
                <tr>
                    <td>Total Bags</td>
                    <td><input type="number" id="bags"></td>
                </tr>

                <tr>
                    <td>Weight Per Bag (KG)</td>
                    <td><input type="number" id="weightPerBag"></td>
                </tr>

                <tr>
                    <td>Total Container Weight (KG)</td>
                    <td><input type="number" id="totalWeight" readonly></td>
                </tr>

                <!-- EXPENSES -->
                <tr>
                    <td>Purchase Cost (AED)</td>
                    <td><input type="number" id="purchase"></td>
                </tr>

                <tr>
                    <td>Shipping & Logistics</td>
                    <td><input type="number" id="shipping"></td>
                </tr>

                <tr>
                    <td>Customs & Other Expenses</td>
                    <td><input type="number" id="customs"></td>
                </tr>

                <!-- MOVED BELOW EXPENSES -->
                <tr>
                    <td>Cost Per Bag (AED)</td>
                    <td><input type="number" id="costPerBag" readonly></td>
                </tr>

                <!-- NEW FIELD -->
                <tr>
                    <td>Bag Selling Price (AED)</td>
                    <td><input type="number" id="bagSelling"></td>
                </tr>

                <!-- NEW AUTO RESULT -->
                <tr>
                    <td>Bag Profit / Loss (AED)</td>
                    <td><input type="text" id="bagProfitLoss" readonly></td>
                </tr>

                <tr>
                    <td>Selling Amount (Total)</td>
                    <td><input type="number" id="selling"></td>
                </tr>

            </table>

            <br>
            <button id="saveBtn" type="submit">Save Container</button>
            <div id="resultBox" style="margin-top:10px;font-weight:bold;"></div>
        </form>
    </section>

</div>

<script>
const bagsEl = document.getElementById("bags");
const weightEl = document.getElementById("weightPerBag");
const totalWeightEl = document.getElementById("totalWeight");

const purchaseEl = document.getElementById("purchase");
const shippingEl = document.getElementById("shipping");
const customsEl = document.getElementById("customs");

const costPerBagEl = document.getElementById("costPerBag");
const bagSellingEl = document.getElementById("bagSelling");
const bagProfitLossEl = document.getElementById("bagProfitLoss");

const sellingEl = document.getElementById("selling");
const resultBox = document.getElementById("resultBox");
const formEl = document.getElementById("containerForm");

function recalcValues() {

    const bags = Number(bagsEl.value || 0);
    const weightPerBag = Number(weightEl.value || 0);

    const purchase = Number(purchaseEl.value || 0);
    const shipping = Number(shippingEl.value || 0);
    const customs = Number(customsEl.value || 0);
    const selling = Number(sellingEl.value || 0);

    const bagSelling = Number(bagSellingEl.value || 0);

    const totalCost = purchase + shipping + customs;

    const totalWeight = bags * weightPerBag;
    totalWeightEl.value = totalWeight || 0;

    const costPerBag = bags > 0 ? (totalCost / bags).toFixed(2) : 0;
    costPerBagEl.value = costPerBag;

    // per bag profit / loss
    const bagProfit = (bagSelling - costPerBag).toFixed(2);
    if (bagSelling > 0 && costPerBag > 0) {
        bagProfitLossEl.value =
            (bagProfit >= 0 ? "Profit " : "Loss ") + Math.abs(bagProfit) + " AED";
    } else {
        bagProfitLossEl.value = "";
    }

    // container profit/loss
    const profitLoss = selling - totalCost;
    if (selling > 0) {
            resultBox.innerHTML =
                (profitLoss >= 0 ? "✅ Profit: AED " : "❌ Loss: AED ") +
                Math.abs(profitLoss);
            resultBox.style.color = profitLoss >= 0 ? "green" : "red";
    }
}

[
 "bags","weightPerBag",
 "purchase","shipping","customs",
 "selling","bagSelling"
].forEach(id => {
    document.getElementById(id).addEventListener("input", recalcValues);
});

/* ---------- EDIT MODE ---------- */
let editIndex = localStorage.getItem("editIndex");
let editData = localStorage.getItem("editData");

if (editData) {
    editData = JSON.parse(editData);

    document.getElementById("formTitle").innerText = "Edit Container";
    document.getElementById("formSubtitle").innerText = "Update container details";
    document.getElementById("saveBtn").innerText = "Update Container";

    document.getElementById("containerDate").value = editData.date || "";
    document.getElementById("containerNo").value = editData.containerNo || "";
    document.getElementById("item").value = editData.item || "";

    bagsEl.value = editData.bags || 0;
    weightEl.value = editData.weightPerBag || 0;
    totalWeightEl.value = editData.totalWeight || 0;

    purchaseEl.value = editData.purchase || 0;
    shippingEl.value = editData.shipping || 0;
    customsEl.value = editData.customs || 0;

    costPerBagEl.value = editData.costPerBag || 0;

    bagSellingEl.value = editData.bagSelling || 0;
    bagProfitLossEl.value = editData.bagProfitLoss || "";

    sellingEl.value = editData.selling || 0;

    recalcValues();
}

/* ---------- SAVE ---------- */
formEl.addEventListener("submit", function(event) {
    event.preventDefault();

    const totalCost =
        Number(purchaseEl.value || 0) +
        Number(shippingEl.value || 0) +
        Number(customsEl.value || 0);

    const payload = {
        containerNo: document.getElementById("containerNo").value,
        item: document.getElementById("item").value,
        date: document.getElementById("containerDate").value,

        bags: Number(bagsEl.value || 0),
        weightPerBag: Number(weightEl.value || 0),
        totalWeight: Number(totalWeightEl.value || 0),

        purchase: Number(purchaseEl.value || 0),
        shipping: Number(shippingEl.value || 0),
        customs: Number(customsEl.value || 0),

        costPerBag: Number(costPerBagEl.value || 0),

        bagSelling: Number(bagSellingEl.value || 0),
        bagProfitLoss: bagProfitLossEl.value,

        selling: Number(sellingEl.value || 0),
        totalCost: totalCost
    };

    payload.profitLoss = payload.selling - payload.totalCost;

    let containers = JSON.parse(localStorage.getItem("containers")) || [];

    if (editIndex !== null) {
        containers[Number(editIndex)] = payload;
        localStorage.removeItem("editIndex");
        localStorage.removeItem("editData");

        resultBox.innerHTML = "✔️ Container updated successfully!";
        resultBox.style.color = "green";
    } else {
        containers.push(payload);

        resultBox.innerHTML =
            (payload.profitLoss >= 0 ? "✅ Profit: AED " : "❌ Loss: AED ") +
            Math.abs(payload.profitLoss);

        resultBox.style.color =
            payload.profitLoss >= 0 ? "green" : "red";

        formEl.reset();
        recalcValues();
    }

    localStorage.setItem("containers", JSON.stringify(containers));
});
</script>

<script src="app.js"></script>
</body>
</html>
