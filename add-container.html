<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Add / Edit Container | Ajwad</title>
    <script src="auth.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="navbar">
    <h2 class="logo">Ajwad</h2>
    <ul>
        <li><a href="index.html">Dashboard</a></li>
        <li><a href="add-container.html">Add Container</a></li>
        <li><a href="containers.html" class="active">Containers</a></li>
        <li><button onclick="logoutUser()" class="logout-btn">Logout</button></li>
    </ul>
</nav>

<div class="page">

    <header class="header">
        <h1 id="formTitle">Add New Container</h1>
        <p id="formSubtitle">Enter container-wise cost, bags & selling details</p>
    </header>

    <section class="containers">

        <form id="containerForm">
            <table>

                <tr>
                    <td>Container Date</td>
                    <td><input type="date" id="containerDate" required></td>
                </tr>

                <tr>
                    <td>Container Number</td>
                    <td><input type="text" id="containerNo" placeholder="AJW-004" required></td>
                </tr>

                <tr>
                    <td>Item</td>
                    <td><input type="text" id="item" placeholder="Onions" required></td>
                </tr>

                <!-- BUSINESS FIELDS -->
                <tr>
                    <td>Total Bags</td>
                    <td><input type="number" id="bags" placeholder="1200"></td>
                </tr>

                <tr>
                    <td>Weight Per Bag (KG)</td>
                    <td><input type="number" id="weightPerBag" placeholder="25"></td>
                </tr>

                <tr>
                    <td>Total Container Weight (KG)</td>
                    <td><input type="number" id="totalWeight" readonly></td>
                </tr>

                <tr>
                    <td>Cost Per Bag (AED)</td>
                    <td><input type="number" id="costPerBag" readonly></td>
                </tr>

                <!-- EXPENSES -->
                <tr>
                    <td>Purchase Cost (AED)</td>
                    <td><input type="number" id="purchase" placeholder="5000"></td>
                </tr>

                <tr>
                    <td>Shipping & Logistics</td>
                    <td><input type="number" id="shipping" placeholder="1500"></td>
                </tr>

                <tr>
                    <td>Customs & Other Expenses</td>
                    <td><input type="number" id="customs" placeholder="800"></td>
                </tr>

                <tr>
                    <td>Selling Amount</td>
                    <td><input type="number" id="selling" placeholder="9000"></td>
                </tr>

            </table>

            <br>
            <button id="saveBtn" type="submit">Save Container</button>
            <div id="resultBox" style="margin-top:10px;font-weight:bold;"></div>
        </form>
    </section>

</div>

<script>
/* ==========================================
   AUTO CALC — TOTAL WEIGHT + COST PER BAG
========================================== */

const bagsEl = document.getElementById("bags");
const weightEl = document.getElementById("weightPerBag");
const totalWeightEl = document.getElementById("totalWeight");
const costPerBagEl = document.getElementById("costPerBag");

const purchaseEl = document.getElementById("purchase");
const shippingEl = document.getElementById("shipping");
const customsEl = document.getElementById("customs");
const sellingEl = document.getElementById("selling");

const resultBox = document.getElementById("resultBox");
const formEl = document.getElementById("containerForm");

function recalcValues() {
    const bags = Number(bagsEl.value || 0);
    const weightPerBag = Number(weightEl.value || 0);
    const purchase = Number(purchaseEl.value || 0);
    const shipping = Number(shippingEl.value || 0);
    const customs = Number(customsEl.value || 0);
    const selling = Number(sellingEl.value || 0);

    const totalCost = purchase + shipping + customs;
    const totalWeight = bags * weightPerBag;
    totalWeightEl.value = totalWeight || 0;

    const costPerBag = bags > 0 ? (totalCost / bags).toFixed(2) : 0;
    costPerBagEl.value = costPerBag;

    // live profit/loss display
    const profitLoss = selling - totalCost;
    if (selling > 0) {
        resultBox.innerHTML = (profitLoss >= 0 ? "✅ Profit: AED " : "❌ Loss: AED ") + Math.abs(profitLoss);
        resultBox.style.color = profitLoss >= 0 ? "green" : "red";
    }
}

// Add event listeners
["bags","weightPerBag","purchase","shipping","customs","selling"].forEach(id => {
    document.getElementById(id).addEventListener("input", recalcValues);
});

/* ==========================================
   EDIT MODE — AUTO FILL EXISTING DATA
========================================== */
let editIndex = localStorage.getItem("editIndex");
let editData = localStorage.getItem("editData");

if (editData) {
    editData = JSON.parse(editData);

    document.getElementById("formTitle").innerText = "Edit Container";
    document.getElementById("formSubtitle").innerText = "Update container details";
    document.getElementById("saveBtn").innerText = "Update Container";

    document.getElementById("containerDate").value = editData.date || "";
    document.getElementById("containerNo").value = editData.containerNo || "";
    document.getElementById("item").value = editData.item || "";

    bagsEl.value = editData.bags || 0;
    weightEl.value = editData.weightPerBag || 0;
    totalWeightEl.value = editData.totalWeight || 0;
    costPerBagEl.value = editData.costPerBag || 0;

    purchaseEl.value = editData.purchase || 0;
    shippingEl.value = editData.shipping || 0;
    customsEl.value = editData.customs || 0;
    sellingEl.value = editData.selling || 0;

    recalcValues();
}

/* ==========================================
   SAVE / UPDATE CONTAINER
========================================== */
formEl.addEventListener("submit", function(event) {
    event.preventDefault();

    const payload = {
        containerNo: document.getElementById("containerNo").value,
        item: document.getElementById("item").value,
        date: document.getElementById("containerDate").value,
        bags: Number(bagsEl.value || 0),
        weightPerBag: Number(weightEl.value || 0),
        totalWeight: Number(totalWeightEl.value || 0),
        costPerBag: Number(costPerBagEl.value || 0),
        purchase: Number(purchaseEl.value || 0),
        shipping: Number(shippingEl.value || 0),
        customs: Number(customsEl.value || 0),
        selling: Number(sellingEl.value || 0),
        totalCost: Number(purchaseEl.value || 0) + Number(shippingEl.value || 0) + Number(customsEl.value || 0),
    };

    payload.profitLoss = payload.selling - payload.totalCost;

    let containers = JSON.parse(localStorage.getItem("containers")) || [];

    if (editIndex !== null) {
        containers[Number(editIndex)] = payload;
        localStorage.removeItem("editIndex");
        localStorage.removeItem("editData");

        resultBox.innerHTML = "✔️ Container updated successfully!";
        resultBox.style.color = "green";
    } else {
        containers.push(payload);
        resultBox.innerHTML = (payload.profitLoss >= 0 ? "✅ Profit: AED " : "❌ Loss: AED ") + Math.abs(payload.profitLoss);
        resultBox.style.color = payload.profitLoss >= 0 ? "green" : "red";

        formEl.reset();
        recalcValues();
    }

    localStorage.setItem("containers", JSON.stringify(containers));
});
</script>

<script src="app.js"></script>
</body>
</html>
