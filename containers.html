<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Containers | Ajwad</title>

    <script src="auth.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>

<body>

<nav class="navbar">
    <h2 class="logo">Ajwad</h2>
    <ul>
        <li><a href="index.html">Dashboard</a></li>
        <li><a href="add-container.html">Add Container</a></li>
        <li><a href="containers.html" class="active">Containers</a></li>
        <li><button onclick="logoutUser()" class="logout-btn">Logout</button></li>
    </ul>
</nav>

<div class="page">

    <header class="header">
        <h1>All Containers</h1>
        <p>Complete container-wise profit, cost & weight details</p>
    </header>

    <section class="containers">

        <input
            type="text"
            id="searchBox"
            placeholder="Search container, item, date, bags, cost, profit..."
            style="width: 100%; padding: 10px; margin-bottom: 12px;"
        />

        <table id="containersTable">
            <thead>
                <tr>
                    <th>Container No</th>
                    <th>Item</th>
                    <th>Date</th>
                    <th>No. of Bags</th>
                    <th>Weight / Bag</th>
                    <th>Total Weight</th>
                    <th>Total Cost</th>
                    <th>Selling</th>
                    <th>Cost / Bag</th>
                    <th>Bag Selling Price</th>
                    <th>Bag Profit / Loss</th>
                    <th>Overall Profit / Loss</th>
                    <th>Action</th>
                </tr>
            </thead>

            <tbody id="allContainersTable"></tbody>
        </table>

    </section>

</div>

<script>
const tableBody = document.getElementById("allContainersTable");
const searchBox  = document.getElementById("searchBox");

function getContainers() {
    return JSON.parse(localStorage.getItem("containers")) || [];
}

function renderTable(list) {
    tableBody.innerHTML = "";

    list.forEach((c, index) => {

        const bags = Number(c.bags || 0);
        const weightPerBag = Number(c.weightPerBag || 0);
        const totalWeight = Number(c.totalWeight || (bags * weightPerBag));

        const totalCost = Number(c.totalCost || 0);
        const selling   = Number(c.selling || 0);

        const costPerBag = Number(c.costPerBag || 0);
        const bagSelling = Number(c.bagSelling || 0);
        const bagProfitLossText = c.bagProfitLoss || "";
        const overallProfitLoss = Number(c.profitLoss || (selling - totalCost));

        const row = `
        <tr>
            <td>${c.containerNo || ""}</td>
            <td>${c.item || ""}</td>
            <td>${c.date || ""}</td>
            <td>${bags}</td>
            <td>${weightPerBag} KG</td>
            <td>${totalWeight} KG</td>
            <td>AED ${totalCost}</td>
            <td>AED ${selling}</td>
            <td>AED ${costPerBag.toFixed(2)}</td>
            <td>AED ${bagSelling.toFixed(2)}</td>
            <td>${bagProfitLossText}</td>
            <td class="${overallProfitLoss >= 0 ? "profit":"loss"}">
                ${overallProfitLoss >= 0 ? "+" : "-"} AED ${Math.abs(overallProfitLoss)}
            </td>
            <td>
                <button onclick="editContainer(${index})" class="edit-btn">Edit</button>
                <button onclick="askDelete(${index})" class="delete-btn">Delete</button>
                <button onclick="createPDF('${c.containerNo}')">Create PDF</button>
            </td>
        </tr>
        `;
        tableBody.insertAdjacentHTML("beforeend", row);
    });
}

function editContainer(index) {
    const containers = getContainers();
    localStorage.setItem("editIndex", index);
    localStorage.setItem("editData", JSON.stringify(containers[index]));
    window.location.href = "add-container.html";
}

let deleteIndex = null;

function askDelete(index) {
    deleteIndex = index;
    document.getElementById("confirmPopup").style.display = "flex";
}

function cancelDelete() {
    deleteIndex = null;
    document.getElementById("confirmPopup").style.display = "none";
}

function confirmDelete() {
    const containers = getContainers();
    containers.splice(deleteIndex, 1);
    localStorage.setItem("containers", JSON.stringify(containers));
    deleteIndex = null;
    document.getElementById("confirmPopup").style.display = "none";
    renderTable(containers);
}

function loadPage() {
    const data = getContainers();
    renderTable(data);

    searchBox.addEventListener("input", e => {
        const q = e.target.value.toLowerCase();
        renderTable(getContainers().filter(c =>
            JSON.stringify(c).toLowerCase().includes(q)
        ));
    });
}

loadPage();

/* ---------- CREATE PDF (USE SAVED VALUES) ---------- */
function createPDF(index) {
    const containers = getContainers() || []; // ensure we always have an array
    const c = containers[index];

    if (!c) {
        alert("Container data not found. Please check the index or saved containers.");
        return;
    }

    // Standardize overall profit/loss field
    let overallProfitLoss =
        c.overallProfitLoss ??
        c.overallProfit ??
        c.totalProfitLoss ??
        c.profitLoss ??
        c.totalProfit ??
        0;

    // Convert numeric values into AED format if needed
    if (typeof overallProfitLoss === "number") {
        overallProfitLoss = `AED ${overallProfitLoss}`;
    }

    // Decide profit / loss color
    const profitClass =
        overallProfitLoss.toString().includes("-")
        ? "loss"
        : "profit";

    const reportWindow = window.open("", "_blank");

    if (!reportWindow) {
        alert("Unable to open PDF window. Please allow pop-ups for this site.");
        return;
    }

    reportWindow.document.open();
    reportWindow.document.write(`
        <html>
        <head>
            <title>Container Report</title>
            <style>
                body {
                    font-family: Arial, Helvetica, sans-serif;
                    padding: 30px;
                    background: #f5f7fb;
                }
                .report-box {
                    max-width: 900px;
                    margin: auto;
                    background: #ffffff;
                    border-radius: 10px;
                    padding: 25px 30px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
                }
                .header { text-align: center; margin-bottom: 20px; }
                .title { font-size: 22px; font-weight: bold; margin-bottom: 5px; }
                .subtitle { font-size: 13px; color: #666; }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 10px;
                    font-size: 14px;
                }
                td {
                    padding: 10px 8px;
                    border-bottom: 1px solid #e6e6e6;
                }
                td:first-child { font-weight: bold; width: 35%; color: #333; }
                td:last-child { text-align: right; color: #222; }
                .profit { font-weight: bold; color: green; }
                .loss { font-weight: bold; color: red; }
            </style>
        </head>
        <body>
            <div class="report-box">
                <div class="header">
                    <div class="title">Container Report</div>
                    <div class="subtitle">Generated from Ajwad Container Management</div>
                </div>
                <table>
                    <tr><td>Container No</td><td>${c.containerNo || "N/A"}</td></tr>
                    <tr><td>Item</td><td>${c.item || "N/A"}</td></tr>
                    <tr><td>Date</td><td>${c.date || "N/A"}</td></tr>
                    <tr><td>No. of Bags</td><td>${c.bags || 0}</td></tr>
                    <tr><td>Weight / Bag</td><td>${c.weightPerBag || 0}</td></tr>
                    <tr><td>Total Weight</td><td>${c.totalWeight || 0}</td></tr>
                    <tr><td>Total Cost</td><td>${c.totalCost || 0}</td></tr>
                    <tr><td>Selling</td><td>${c.selling || 0}</td></tr>
                    <tr><td>Cost / Bag</td><td>${c.costPerBag || 0}</td></tr>
                    <tr><td>Bag Selling Price</td><td>${c.bagSelling || 0}</td></tr>
                    <tr><td>Bag Profit / Loss</td><td>${c.bagProfitLoss || 0}</td></tr>
                    <tr>
                        <td>Overall Profit / Loss</td>
                        <td class="${profitClass}">${overallProfitLoss}</td>
                    </tr>
                </table>
            </div>
        </body>
        </html>
    `);

    reportWindow.document.close();
    reportWindow.onload = () => reportWindow.print();
}
</script>

<!-- Delete confirmation popup -->
<div id="confirmPopup" class="popup-overlay" style="display:none;">
    <div class="popup-box">
        <h3>Delete Container?</h3>
        <p>This action cannot be undone.</p>
        <div class="popup-actions">
            <button onclick="confirmDelete()">Yes, Delete</button>
            <button onclick="cancelDelete()">Cancel</button>
        </div>
    </div>
</div>

</body>
</html>
