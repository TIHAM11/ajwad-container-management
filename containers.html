<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Containers | Ajwad</title>

    <script src="auth.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>

<body>

<nav class="navbar">
    <h2 class="logo">Ajwad</h2>
    <ul>
        <li><a href="index.html">Dashboard</a></li>
        <li><a href="add-container.html">Add Container</a></li>
        <li><a href="containers.html" class="active">Containers</a></li>
        <li><button onclick="logoutUser()" class="logout-btn">Logout</button></li>
    </ul>
</nav>

<div class="page">

    <header class="header">
        <h1>All Containers</h1>
        <p>Complete container-wise profit, cost & weight details</p>
    </header>

    <section class="containers">

        <input
            type="text"
            id="searchBox"
            placeholder="Search container, item, date, bags, cost, profit..."
            style="width: 100%; padding: 10px; margin-bottom: 12px;"
        />

        <table id="containersTable">
            <thead>
                <tr>
                    <th>Container No</th>
                    <th>Item</th>
                    <th>Date</th>
                    <th>No. of Bags</th>
                    <th>Weight / Bag</th>
                    <th>Total Weight</th>
                    <th>Total Cost</th>
                    <th>Selling</th>

                    <th>Cost / Bag</th>
                    <th>Bag Selling Price</th>
                    <th>Bag Profit / Loss</th>
                    <th>Overall Profit / Loss</th>

                    <th>Action</th>
                </tr>
            </thead>

            <tbody id="allContainersTable"></tbody>
        </table>

    </section>

</div>

<script>
const tableBody = document.getElementById("allContainersTable");
const searchBox  = document.getElementById("searchBox");

function getContainers() {
    return JSON.parse(localStorage.getItem("containers")) || [];
}

/* ---------- RENDER TABLE (USE SAVED VALUES ONLY) ---------- */
function renderTable(list) {

    tableBody.innerHTML = "";

    list.forEach((c, index) => {

        const bags = Number(c.bags || 0);
        const weightPerBag = Number(c.weightPerBag || 0);
        const totalWeight = Number(c.totalWeight || (bags * weightPerBag));

        const totalCost = Number(c.totalCost || 0);
        const selling   = Number(c.selling || 0);

        /* ✅ DIRECTLY USE SAVED VALUES */
        const costPerBag = Number(c.costPerBag || 0);
        const bagSelling = Number(c.bagSelling || 0);

        /* ❗ NO RECALCULATION — USE EXACT SAVED TEXT */
        const bagProfitLossText = c.bagProfitLoss || "";

        /* overall profit already saved in add-container */
        const overallProfitLoss = Number(c.profitLoss || (selling - totalCost));

        const row = `
        <tr>
            <td>${c.containerNo || ""}</td>
            <td>${c.item || ""}</td>
            <td>${c.date || ""}</td>

            <td>${bags}</td>
            <td>${weightPerBag} KG</td>
            <td>${totalWeight} KG</td>

            <td>AED ${totalCost}</td>
            <td>AED ${selling}</td>

            <td>AED ${costPerBag.toFixed(2)}</td>
            <td>AED ${bagSelling.toFixed(2)}</td>

            <td>${bagProfitLossText}</td>

            <td class="${overallProfitLoss >= 0 ? "profit":"loss"}">
                ${overallProfitLoss >= 0 ? "+" : "-"} AED ${Math.abs(overallProfitLoss)}
            </td>

            <td>
                <button onclick="editContainer(${index})" class="edit-btn">Edit</button>
                <button onclick="askDelete(${index})" class="delete-btn">Delete</button>
                <button onclick="createPDF(this)">Create PDF</button>
            </td>
        </tr>
        `;

        tableBody.insertAdjacentHTML("beforeend", row);
    });
}

/* ---------- EDIT ---------- */
function editContainer(index) {
    const containers = getContainers();
    const data = containers[index];

    localStorage.setItem("editIndex", index);
    localStorage.setItem("editData", JSON.stringify(data));

    window.location.href = "add-container.html";
}

/* ---------- DELETE ---------- */
let deleteIndex = null;

function askDelete(index) {
    deleteIndex = index;
    document.getElementById("confirmPopup").style.display = "flex";
}

function cancelDelete() {
    deleteIndex = null;
    document.getElementById("confirmPopup").style.display = "none";
}

function confirmDelete() {
    const containers = getContainers();
    containers.splice(deleteIndex, 1);

    localStorage.setItem("containers", JSON.stringify(containers));

    deleteIndex = null;
    document.getElementById("confirmPopup").style.display = "none";

    renderTable(containers);
}

/* ---------- LOAD & SEARCH ---------- */
function loadPage() {

    const data = getContainers();
    renderTable(data);

    searchBox.addEventListener("input", e => {
        const q = e.target.value.toLowerCase();

        const filtered = getContainers().filter(c =>
            JSON.stringify(c).toLowerCase().includes(q)
        );

        renderTable(filtered);
    });
}

loadPage();

/* ------- PROFESSIONAL INVOICE / BILL LAYOUT -------- */
function createPDF(btn) {

    const row = btn.closest("tr").children;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    const c = {
        containerNo: row[0].innerText.trim(),
        item: row[1].innerText.trim(),
        date: row[2].innerText.trim(),
        bags: row[3].innerText.trim(),
        weightPerBag: row[4].innerText.trim(),
        totalWeight: row[5].innerText.trim(),
        totalCost: row[6].innerText.trim(),
        sellingPrice: row[7].innerText.trim(),
        costPerBag: row[8].innerText.trim(),
        bagSellingPrice: row[9].innerText.trim(),
        bagProfitLoss: row[10].innerText.trim(),
        overallProfitLoss: row[11].innerText.trim()
    };

    // ===== TOP HEADER BAR =====
    doc.setFillColor(18, 63, 122); // navy blue
    doc.rect(0, 0, 210, 28, "F");

    // ===== BRAND NAME =====
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.setTextColor(255, 255, 255);
    doc.text("AJWAD", 12, 17);

    // ===== SUBTITLE =====
    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.text("Container Bill / Invoice", 12, 24);

    // ===== BILL META (RIGHT SIDE) =====
    const today = new Date().toISOString().split("T")[0];

    doc.setFontSize(11);
    doc.text(`Bill Date : ${today}`, 198, 12, { align: "right" });
    doc.text(`Container No : ${c.containerNo}`, 198, 18, { align: "right" });

    // ========= CARD BOX =========
    doc.setDrawColor(200, 200, 200);
    doc.roundedRect(15, 38, 180, 120, 3, 3);

    // ========= SECTION TITLE =========
    doc.setTextColor(0, 0, 0);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(13);
    doc.text("Container Details", 20, 48);

    // ========= DETAILS TABLE =========
    const rows = [
        ["Item", c.item],
        ["Date", c.date],
        ["No. of Bags", c.bags],
        ["Weight Per Bag", c.weightPerBag],
        ["Total Weight", c.totalWeight],
        ["Total Cost", c.totalCost],
        ["Selling Price", c.sellingPrice],
        ["Cost Per Bag", c.costPerBag],
        ["Bag Selling Price", c.bagSellingPrice],
        ["Bag Profit / Loss", c.bagProfitLoss]
    ];

    let y = 60;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);

    rows.forEach(r => {
        doc.text(r[0], 24, y);
        doc.text(r[1], 120, y);
        y += 10;
    });

    // ===== OVERALL PROFIT BOX =====
    doc.setFont("helvetica", "bold");
    doc.text("Overall Profit / Loss", 20, 150);

    doc.setFillColor(0, 140, 60);
    doc.roundedRect(110, 142, 40, 12, 2, 2, "F");

    doc.setTextColor(255, 255, 255);
    doc.text(c.overallProfitLoss, 130, 150, { align: "center" });

    // ===== FOOTER =====
    doc.setTextColor(60, 60, 60);
    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);

    doc.text(
        "Generated from Ajwad Container Management System",
        15,
        188
    );

    doc.text(
        "This is a system-generated bill — No signature required",
        15,
        194
    );

    // ===== SAVE FILE =====
    doc.save(`Container_Bill_${c.containerNo}.pdf`);
}
</script>

<!-- Delete confirmation popup -->
<div id="confirmPopup" class="popup-overlay" style="display:none;">
    <div class="popup-box">
        <h3>Delete Container?</h3>
        <p>This action cannot be undone.</p>

        <div class="popup-actions">
            <button onclick="confirmDelete()" class="confirm-btn">Yes, Delete</button>
            <button onclick="cancelDelete()" class="cancel-btn">Cancel</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

</body>
</html>
